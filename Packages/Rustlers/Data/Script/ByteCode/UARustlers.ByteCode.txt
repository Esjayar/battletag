

VAR nb_lifepoint	SEND
VAR nb_ammo		SEND	
VAR nb_clip		SEND
VAR nb_shoot		SEND
VAR energy		SEND
VAR last_base		SEND
VAR display
VAR max_lifepoint	CONFIG
VAR max_ammo	CONFIG
VAR max_clip		CONFIG
VAR swap_on		CONFIG
VAR respawn_time	CONFIG
VAR team		CONFIG
VAR team_frag		CONFIG
VAR medic		CONFIG
VAR team_base
VAR energy_base
VAR lastrfid_type	
VAR last_ammo_rfid	
VAR last_medikit_rfid	
VAR scan_ok
VAR local
VAR timer
VAR auto_reload


FUNCTION hud
IF	display 	COMP		1
	HUD_ICON_ON	BULLET
	HUD_ICON_OFF	LIFE
	
	IF	max_ammo	DIFF	20
		IF	nb_ammo		SUP	0
			HUD_DIGIT	nb_ammo
			HUD_JAUGE	nb_clip
		ELSE
			HUD_DIGIT_BLINK	nb_ammo
			HUD_JAUGE_BLINK	nb_clip
		END_IF
	ELSE
		HUD_DIGIT_OFF
		HUD_JAUGE_BLINK	1
	END_IF
ELSE
	IF	energy	DIFF	0
		HUD_ICON_OFF	LIFE
		HUD_ICON_OFF	BULLET

		HUD_DIGIT_BLINK	energy
		HUD_JAUGE	0
	ELSE
		HUD_ICON_ON	LIFE
		HUD_ICON_OFF	BULLET

		IF	nb_lifepoint COMP 0
			HUD_DIGIT_BLINK	nb_lifepoint
		ELSE	
			HUD_DIGIT		nb_lifepoint
		END_IF

		HUD_JAUGE	0
	END_IF
END_IF












































































END_FUNCTION

FUNCTION respawn
HUD_ICON_OFF		GOAL
SET	nb_lifepoint	max_lifepoint
SET	nb_clip		max_clip
SET	nb_ammo		max_ammo
DEC 	nb_clip

SET 	display		1
hud

GOTO	game




































































END_FUNCTION

FUNCTION get_hit
MOTOR	30

IF	energy SUP	0
	DEC energy 
	IF	energy COMP	0
		SND_PRIO	SG03	
	ELSE
		SND	SC11
	END_IF
ELSE
	IF nb_lifepoint SUP	0
		DEC nb_lifepoint
		SND	HURT
	END_IF
END_IF

LED_ON		30	1

IF nb_lifepoint COMP	0
	GOTO	death
END_IF

SET display 0
hud


































































END_FUNCTION

FUNCTION reload
SET	nb_clip		max_clip
SET 	last_ammo_rfid 	lastrfid_type
SET	display		1


































































END_FUNCTION

FUNCTION medikit
SET	nb_lifepoint	max_lifepoint
SET 	last_medikit_rfid 	lastrfid_type
SET	display		0
hud


































































END_FUNCTION

FUNCTION energy
SET	local	0

IF	energy		COMP	0
	IF lastrfid_type COMP	energy_base
		SET	local	1
		FLASH_GREEN	1
		SET	energy	nb_lifepoint
		SND_PRIO	SG02
	END_IF
END_IF

IF 	energy		SUP	0
	IF lastrfid_type COMP	team_base
		SET	local	1
		FLASH_GREEN	1
		SET	energy	0
	END_IF
END_IF

IF	local	COMP	0
	SND	SCAN_BAD
ELSE
	SND	OK
	SET	last_base		lastrfid_type
END_IF
SET display 0
hud


END_FUNCTION

STATE init 

FIRST_STATE

EVENT ENTER_STATE
TIMER		50
SET_HARNESS	1
SET	nb_shoot		0

IF team_frag COMP 0
	SET_TEAM	team	
END_IF

SET team_base	team
DEC team_base

IF	team_base	COMP	0
	SET	energy_base	2
ELSE
	SET	energy_base	3
END_IF
SET	last_base		0
SET	energy		0
	
SND START
respawn















































































END_EVENT

END_STATE

STATE game 

EVENT BUTTON_2_JUST_PRESSED
SET	display		1
IF	nb_ammo		SUP	0
	IF	max_ammo	DIFF	20	
		DEC		nb_ammo
	ELSE
		ANIM		ASHT
	END_IF
	SND		SHOOT
	FLASH_ORANGE	1
	IR
	INC	nb_shoot

	IF	nb_ammo		COMP	0
		IF nb_clip SUP 0
			SET	auto_reload	1
		END_IF
	END_IF
ELSE
	IF nb_clip COMP 0
		SND		EMPTY
	END_IF
END_IF
hud













































































END_EVENT

EVENT BUTTON_3_JUST_PRESSED
RFID_SCAN	scan_ok
SET local 0
IF	scan_ok		COMP	1

	RFID_TYPE_MAJOR	lastrfid_type

	IF lastrfid_type COMP RFID_AMMO_PACK
		SET local 1
		RFID_TYPE_MINOR lastrfid_type
		GOTO	reload
	END_IF

	IF	medic	COMP	1
		IF lastrfid_type COMP RFID_LIFE_PACK
			SET local 1
			RFID_TYPE_MINOR lastrfid_type
			GOTO	medikit
		END_IF
	END_IF

	IF lastrfid_type COMP RFID_BASE_PACK
		SET local 1
		RFID_TYPE_MINOR lastrfid_type
		energy
	END_IF

END_IF

IF local COMP	0
	SND	SCAN_BAD
END_IF





































































END_EVENT

EVENT HIT
get_hit









































































END_EVENT

EVENT BUTTON_1_JUST_PRESSED
SND	BIP
IF display COMP 1
	SET display 0
ELSE
	SET display 1
END_IF
hud
































































END_EVENT

EVENT TIMER
IF 	auto_reload	COMP	1
	DEC 	nb_clip
	SND	RELOAD
	SET	nb_ammo		max_ammo
	hud
	SET	auto_reload	0
END_IF

IF	energy	DIFF	0
	INC	timer
	IF	timer	SUP	5
		SET	timer	0
	END_IF
	HUD_JAUGE	timer
END_IF





































END_EVENT

EVENT ENTER_STATE
SET	auto_reload	0
SET	timer	0








END_EVENT

EVENT ANIM_FINISHED
HUD_JAUGE_BLINK	1
HUD_ICON_ON	BULLET







END_EVENT

END_STATE

STATE reload 

EVENT ENTER_STATE
IF swap_on COMP 1
	IF lastrfid_type COMP last_ammo_rfid
		SND	SCAN_BAD
		GOTO game
	ELSE
		SND	RELOAD_CLIP
		FLASH_GREEN	1
		ANIM	ARAM
	END_IF	
ELSE	
	SND	RELOAD_CLIP
	FLASH_GREEN	1
	ANIM	ARAM
END_IF

	








































































END_EVENT

EVENT ANIM_FINISHED
reload
SET	nb_ammo		max_ammo
DEC 	nb_clip
hud
GOTO	game





































END_EVENT

EVENT HIT
reload
DEC 	nb_clip
SET	nb_ammo		max_ammo
ANIM_OFF
get_hit
GOTO	game

































































END_EVENT

END_STATE

STATE medikit 

EVENT ENTER_STATE
IF swap_on COMP 1
	IF lastrfid_type COMP last_medikit_rfid
		SND	SCAN_BAD
		GOTO game
	ELSE
		SND	SCAN_GOOD
		FLASH_GREEN	1
		ANIM	AMED
	END_IF	
ELSE	
	SND	SCAN_GOOD
	FLASH_GREEN	1	
	ANIM	AMED
END_IF



































END_EVENT

EVENT ANIM_FINISHED
medikit
GOTO	game














































END_EVENT

EVENT HIT
medikit
ANIM_OFF
get_hit
GOTO	game














































END_EVENT

END_STATE

STATE respawn 

EVENT ENTER_STATE
TIMER	200
SND	SCAN_GOOD
SET 	local 	0
ANIM_OFF
HUD_DIGIT	respawn_time









































END_EVENT

EVENT TIMER
IF	local	COMP 0

	SET	local	1
	SET	timer	respawn_time
	TIMER	100

ELSE

	IF	timer	COMP	0

		SND_PRIO	RESPAWN
		LED_OFF
		FLASH_RED	0
		respawn	

	ELSE
	
		DEC		timer	
		HUD_DIGIT	timer	
		SND	BIP

	END_IF

END_IF







































END_EVENT

END_STATE

STATE death 

EVENT ENTER_STATE
TIMER	100
SND_PRIO		DEAD
LED_INFINITE	30
FLASH_RED	255
IF 	team_base	COMP	0
	ANIM_LOOP	AGB1
END_IF
IF 	team_base	COMP	1
	ANIM_LOOP	AGB2
END_IF
IF 	team_base	COMP	2
	ANIM_LOOP	AGB3
END_IF
IF 	team_base	COMP	3
	ANIM_LOOP	AGB4
END_IF






































END_EVENT

EVENT BUTTON_3_JUST_PRESSED
RFID_SCAN	scan_ok
IF	scan_ok		COMP	1

	RFID_TYPE_MAJOR	lastrfid_type
	IF lastrfid_type COMP RFID_BASE_PACK
		RFID_TYPE_MINOR	lastrfid_type	
		IF lastrfid_type COMP team_base
			FLASH_GREEN	10
			GOTO respawn
			SET 	scan_ok		0
		END_IF
	END_IF

	IF	scan_ok		COMP	1
		SND	SCAN_BAD
	END

ELSE
	SND	SCAN_BAD
END_IF















































END_EVENT

END_STATE
