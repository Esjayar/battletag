

VAR nb_stage		CONFIG
VAR assist		CONFIG
VAR score		SEND
VAR nb_hit		RECEIVE
VAR stage
VAR local
VAR timer
VAR scan_rfid


FUNCTION tag
IF stage COMP 0
	ANIM_LOOP	AGB1
END_IF
IF stage COMP 1
	ANIM_LOOP	AGB2
END_IF
IF stage COMP 2
	ANIM_LOOP	AGB3
END_IF
IF stage COMP 3
	ANIM_LOOP	AGB4
END_IF
SET	timer 	1
GOTO tag


END_FUNCTION

FUNCTION shoot
IF stage COMP nb_stage
	SET stage 0
END_IF

ANIM_LOOP	AUBI
SET	timer 	1
GOTO shoot


END_FUNCTION

STATE init 

FIRST_STATE

EVENT ENTER_STATE
TIMER	100
SET_HARNESS	0
SND START
SET stage 0
SET score 0
SET nb_hit 0	
tag
















END_EVENT

END_STATE

STATE tag 

EVENT BUTTON_3_JUST_PRESSED
RFID_SCAN	scan_rfid
SET local 0
IF scan_rfid COMP	1

	RFID_TYPE_MAJOR scan_rfid
	IF scan_rfid COMP RFID_BASE_PACK 

		RFID_TYPE_MINOR scan_rfid
		IF scan_rfid COMP stage
			SET local 1
			INC stage
			INC score
		END_IF

	END_IF

END_IF

IF local COMP 1
	FLASH_GREEN	10
	SND SCAN_GOOD
	shoot
ELSE
	SND SCAN_BAD
END_IF









END_EVENT

EVENT TIMER
IF assist	COMP	1
	IF	timer	COMP	0
		SET	timer	8
		IF stage COMP 0
			SND ASSIST_BASE1
		END_IF
		IF stage COMP 1
			SND ASSIST_BASE2
		END_IF
		IF stage COMP 2
			SND ASSIST_BASE3
		END_IF
		IF stage COMP 3
			SND ASSIST_BASE4
		END_IF
	END_IF
	DEC	timer
	
END_IF



END_EVENT

END_STATE

STATE shoot 

EVENT BUTTON_2_JUST_PRESSED
IR
SND SHOOT
FLASH_ORANGE 10














END_EVENT

EVENT DATA_CHANGE
nb_hit
SND SCAN_GOOD
tag














END_EVENT

EVENT TIMER
IF assist	COMP	1

	IF	timer	COMP	0
		SET	timer	8
		SND ASSIST_UBICONNECT
	END_IF
	DEC	timer

END_IF



END_EVENT

END_STATE
